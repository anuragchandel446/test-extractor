<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Debug Tools - Moon Stoners TTS Reader</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Custom Cosmic Theme -->
    <link rel="stylesheet" href="kc.css" />
</head>
<body data-page="debug">
    <!-- Navigation -->
    <nav class="main-navigation" role="navigation" aria-label="Main navigation"></nav>
    
    <!-- Page Content -->
    <main class="page-content" role="main">
        <div class="container-fluid">
            <header class="page-header">
                <h1 class="page-title">
                    <i class="bi bi-bug"></i>
                    Debug & Error Analysis
                </h1>
                <p class="page-subtitle">Comprehensive debugging tool for all features</p>
            </header>

            <div class="row g-4">
                <!-- Console Errors -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                JavaScript Errors
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="errorLog" class="bg-dark text-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: monospace;">
                                <div class="text-success">Debug console initialized...</div>
                            </div>
                            <div class="mt-3">
                                <button id="clearErrors" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-trash me-1"></i>Clear Log
                                </button>
                                <button id="exportErrors" class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-download me-1"></i>Export Log
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feature Tests -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-check-circle me-2"></i>
                                Feature Tests
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="testResults" style="height: 300px; overflow-y: auto;">
                                <p class="text-muted">Click "Run All Tests" to check feature functionality</p>
                            </div>
                            <div class="mt-3">
                                <button id="runAllTests" class="btn btn-primary">
                                    <i class="bi bi-play me-1"></i>Run All Tests
                                </button>
                                <button id="testTTS" class="btn btn-outline-success btn-sm">TTS</button>
                                <button id="testOCR" class="btn btn-outline-info btn-sm">OCR</button>
                                <button id="testTranslation" class="btn btn-outline-warning btn-sm">Translation</button>
                                <button id="testVoice" class="btn btn-outline-secondary btn-sm">Voice</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Status -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-wifi me-2"></i>
                                API & Service Status
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <div id="speechApiStatus" class="mb-2">
                                            <i class="bi bi-circle-fill text-secondary"></i>
                                            <span class="ms-2">Speech API</span>
                                        </div>
                                        <small class="text-muted">Web Speech API</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <div id="ocrApiStatus" class="mb-2">
                                            <i class="bi bi-circle-fill text-secondary"></i>
                                            <span class="ms-2">OCR API</span>
                                        </div>
                                        <small class="text-muted">Tesseract.js</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <div id="translationApiStatus" class="mb-2">
                                            <i class="bi bi-circle-fill text-secondary"></i>
                                            <span class="ms-2">Translation API</span>
                                        </div>
                                        <small class="text-muted">MyMemory API</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <div id="voiceApiStatus" class="mb-2">
                                            <i class="bi bi-circle-fill text-secondary"></i>
                                            <span class="ms-2">Voice Recognition</span>
                                        </div>
                                        <small class="text-muted">Speech Recognition</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Fixes -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-tools me-2"></i>
                                Quick Fixes
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-2 flex-wrap">
                                <button id="fixNavigation" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-compass me-1"></i>Fix Navigation
                                </button>
                                <button id="fixTTS" class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-volume-up me-1"></i>Fix TTS
                                </button>
                                <button id="fixOCR" class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-camera me-1"></i>Fix OCR
                                </button>
                                <button id="fixTranslation" class="btn btn-outline-warning btn-sm">
                                    <i class="bi bi-translate me-1"></i>Fix Translation
                                </button>
                                <button id="fixVoiceInput" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-mic me-1"></i>Fix Voice Input
                                </button>
                                <button id="resetAll" class="btn btn-outline-danger btn-sm">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Reset All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Authentication Database -->
    <script src="auth-db.js"></script>
    <!-- Shared Navigation -->
    <script src="shared-navigation.js"></script>
    <!-- Voice Quality Enhancement System -->
    <script src="voice-quality-enhancer.js"></script>
    
    <script>
        // Authentication check
        const isLoggedIn = localStorage.getItem('kc_logged_in');
        if(!(isLoggedIn === '1')){
            window.location.href = 'login.html';
        }

        // Error logging system
        const errorLog = document.getElementById('errorLog');
        const errors = [];

        function logError(message, type = 'error') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            errors.push(logEntry);
            
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-danger' : type === 'warning' ? 'text-warning' : 'text-info';
            div.textContent = logEntry;
            errorLog.appendChild(div);
            errorLog.scrollTop = errorLog.scrollHeight;
        }

        function logSuccess(message) {
            logError(message, 'success');
        }

        function logWarning(message) {
            logError(message, 'warning');
        }

        // Override console methods to capture errors
        const originalError = console.error;
        const originalWarn = console.warn;
        const originalLog = console.log;

        console.error = function(...args) {
            logError(args.join(' '));
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            logWarning(args.join(' '));
            originalWarn.apply(console, args);
        };

        // Capture unhandled errors
        window.addEventListener('error', (event) => {
            logError(`${event.filename}:${event.lineno} - ${event.message}`);
        });

        window.addEventListener('unhandledrejection', (event) => {
            logError(`Unhandled Promise Rejection: ${event.reason}`);
        });

        // API Status Checkers
        function updateApiStatus(elementId, status, message = '') {
            const element = document.getElementById(elementId);
            const icon = element.querySelector('i');
            
            if (status === 'success') {
                icon.className = 'bi bi-circle-fill text-success';
            } else if (status === 'error') {
                icon.className = 'bi bi-circle-fill text-danger';
            } else {
                icon.className = 'bi bi-circle-fill text-warning';
            }
            
            if (message) {
                element.title = message;
            }
        }

        // Test Functions
        async function testSpeechAPI() {
            logError('Testing Speech API...', 'info');
            try {
                if ('speechSynthesis' in window) {
                    const voices = speechSynthesis.getVoices();
                    updateApiStatus('speechApiStatus', 'success', `${voices.length} voices available`);
                    logSuccess(`Speech API: ${voices.length} voices available`);
                    return true;
                } else {
                    throw new Error('Speech Synthesis not supported');
                }
            } catch (error) {
                updateApiStatus('speechApiStatus', 'error', error.message);
                logError(`Speech API: ${error.message}`);
                return false;
            }
        }

        async function testOCRAPI() {
            logError('Testing OCR API...', 'info');
            try {
                if (typeof Tesseract !== 'undefined') {
                    updateApiStatus('ocrApiStatus', 'success', 'Tesseract.js loaded');
                    logSuccess('OCR API: Tesseract.js loaded successfully');
                    return true;
                } else {
                    throw new Error('Tesseract.js not loaded');
                }
            } catch (error) {
                updateApiStatus('ocrApiStatus', 'error', error.message);
                logError(`OCR API: ${error.message}`);
                return false;
            }
        }

        async function testTranslationAPI() {
            logError('Testing Translation API...', 'info');
            try {
                const response = await fetch('https://api.mymemory.translated.net/get?q=hello&langpair=en|es', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateApiStatus('translationApiStatus', 'success', 'MyMemory API accessible');
                    logSuccess('Translation API: MyMemory API accessible');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateApiStatus('translationApiStatus', 'error', error.message);
                logError(`Translation API: ${error.message}`);
                return false;
            }
        }

        async function testVoiceRecognitionAPI() {
            logError('Testing Voice Recognition API...', 'info');
            try {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    updateApiStatus('voiceApiStatus', 'success', 'Speech Recognition available');
                    logSuccess('Voice Recognition API: Available');
                    return true;
                } else {
                    throw new Error('Speech Recognition not supported');
                }
            } catch (error) {
                updateApiStatus('voiceApiStatus', 'error', error.message);
                logError(`Voice Recognition API: ${error.message}`);
                return false;
            }
        }

        // Enhanced TTS Feature Tests with Quality Analysis
        async function testTTSFeature() {
            logError('Testing Enhanced TTS Feature...', 'info');
            const results = [];
            
            // Test speech synthesis
            if (await testSpeechAPI()) {
                results.push('✅ Speech API working');
            } else {
                results.push('❌ Speech API failed');
            }
            
            // Test voice loading and quality analysis
            try {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    results.push(`✅ ${voices.length} voices loaded`);
                    
                    // Test voice quality enhancement system
                    if (typeof EnhancedTTSManager !== 'undefined') {
                        const enhancedTTS = new EnhancedTTSManager();
                        await enhancedTTS.initialize();
                        const qualityInfo = enhancedTTS.getVoiceQualityInfo();
                        
                        const highQualityVoices = qualityInfo.availableVoices.filter(v => v.qualityScore >= 70).length;
                        results.push(`✅ Voice Quality System: ${highQualityVoices} high-quality voices detected`);
                        
                        if (qualityInfo.currentVoice) {
                            results.push(`✅ Best Voice: ${qualityInfo.currentVoice.name} (${qualityInfo.currentVoice.qualityScore}% quality)`);
                        }
                    } else {
                        results.push('⚠️ Voice Quality Enhancement not loaded');
                    }
                } else {
                    results.push('⚠️ No voices available');
                }
            } catch (error) {
                results.push('❌ Voice loading failed: ' + error.message);
            }
            
            return results;
        }

        async function testOCRFeature() {
            logError('Testing OCR Feature...', 'info');
            const results = [];
            
            // Test Tesseract loading
            if (await testOCRAPI()) {
                results.push('✅ Tesseract.js loaded');
            } else {
                results.push('❌ Tesseract.js not loaded');
            }
            
            // Test file input support
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                results.push('✅ File input supported');
            } catch (error) {
                results.push('❌ File input not supported');
            }
            
            return results;
        }

        async function testTranslationFeature() {
            logError('Testing Translation Feature...', 'info');
            const results = [];
            
            // Test translation API
            if (await testTranslationAPI()) {
                results.push('✅ Translation API accessible');
            } else {
                results.push('❌ Translation API failed');
            }
            
            return results;
        }

        async function testVoiceInputFeature() {
            logError('Testing Voice Input Feature...', 'info');
            const results = [];
            
            // Test voice recognition
            if (await testVoiceRecognitionAPI()) {
                results.push('✅ Voice Recognition available');
            } else {
                results.push('❌ Voice Recognition not supported');
            }
            
            return results;
        }

        // Event Listeners
        document.getElementById('clearErrors').addEventListener('click', () => {
            errorLog.innerHTML = '<div class="text-success">Debug console cleared...</div>';
            errors.length = 0;
        });

        document.getElementById('exportErrors').addEventListener('click', () => {
            const blob = new Blob([errors.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'debug_log.txt';
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('runAllTests').addEventListener('click', async () => {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = '<div class="text-info">Running comprehensive tests...</div>';
            
            const allResults = [];
            
            // Test all features
            const ttsResults = await testTTSFeature();
            const ocrResults = await testOCRFeature();
            const translationResults = await testTranslationFeature();
            const voiceResults = await testVoiceInputFeature();
            
            allResults.push('<h6>TTS Feature:</h6>', ...ttsResults.map(r => `<div>${r}</div>`));
            allResults.push('<h6>OCR Feature:</h6>', ...ocrResults.map(r => `<div>${r}</div>`));
            allResults.push('<h6>Translation Feature:</h6>', ...translationResults.map(r => `<div>${r}</div>`));
            allResults.push('<h6>Voice Input Feature:</h6>', ...voiceResults.map(r => `<div>${r}</div>`));
            
            testResults.innerHTML = allResults.join('');
        });

        // Individual test buttons
        document.getElementById('testTTS').addEventListener('click', async () => {
            const results = await testTTSFeature();
            document.getElementById('testResults').innerHTML = '<h6>TTS Test Results:</h6>' + results.map(r => `<div>${r}</div>`).join('');
        });

        document.getElementById('testOCR').addEventListener('click', async () => {
            const results = await testOCRFeature();
            document.getElementById('testResults').innerHTML = '<h6>OCR Test Results:</h6>' + results.map(r => `<div>${r}</div>`).join('');
        });

        document.getElementById('testTranslation').addEventListener('click', async () => {
            const results = await testTranslationFeature();
            document.getElementById('testResults').innerHTML = '<h6>Translation Test Results:</h6>' + results.map(r => `<div>${r}</div>`).join('');
        });

        document.getElementById('testVoice').addEventListener('click', async () => {
            const results = await testVoiceInputFeature();
            document.getElementById('testResults').innerHTML = '<h6>Voice Input Test Results:</h6>' + results.map(r => `<div>${r}</div>`).join('');
        });

        // Quick fix buttons
        document.getElementById('fixNavigation').addEventListener('click', () => {
            logError('Checking navigation system...', 'info');
            if (window.navigationManager) {
                logSuccess('Navigation system is working');
            } else {
                logError('Navigation system not initialized');
                // Reload shared navigation
                const script = document.createElement('script');
                script.src = 'shared-navigation.js';
                document.head.appendChild(script);
            }
        });

        document.getElementById('resetAll').addEventListener('click', () => {
            if (confirm('This will clear all localStorage data and reload the page. Continue?')) {
                localStorage.clear();
                location.reload();
            }
        });

        // Initialize
        setTimeout(() => {
            logSuccess('Debug tool initialized');
            testSpeechAPI();
            testOCRAPI();
            testTranslationAPI();
            testVoiceRecognitionAPI();
        }, 1000);

        console.log('Debug tool loaded successfully');
    </script>
</body>
</html>
</content>