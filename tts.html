<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Text-to-Speech - Moon Stoners TTS Reader</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Custom Cosmic Theme -->
    <link rel="stylesheet" href="kc.css" />
    <style>
        .nav-breadcrumb {
            background: rgba(10, 10, 15, 0.1);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(0, 212, 255, 0.1);
        }
        
        .nav-breadcrumb a {
            color: var(--cosmic-cyan);
            text-decoration: none;
        }
        
        .nav-breadcrumb a:hover {
            color: var(--aurora-pink);
        }
        
        .main-editor {
            min-height: 400px;
        }
        
        .voice-preview-section {
            background: linear-gradient(135deg, 
                rgba(157, 78, 221, 0.1), 
                rgba(0, 212, 255, 0.1));
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .playback-controls {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 1rem;
            text-align: center;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            margin: 0 0.5rem;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        .control-btn.play {
            background: linear-gradient(135deg, var(--neon-green), var(--galaxy-gold));
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }
        
        .control-btn.pause {
            background: linear-gradient(135deg, var(--galaxy-gold), var(--plasma-orange));
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }
        
        .control-btn.stop {
            background: linear-gradient(135deg, var(--aurora-pink), var(--nebula-pink));
            box-shadow: 0 8px 25px rgba(255, 61, 113, 0.4);
        }
    </style>
</head>
<body data-page="tts">
    <!-- Enhanced cosmic visual elements -->
    <div class="cosmic-orb"></div>
    <div class="cosmic-orb"></div>
    <div class="cosmic-orb"></div>
    
    <!-- Navigation -->
    <nav class="main-navigation" role="navigation" aria-label="Main navigation"></nav>
    
    <!-- Page Content -->
    <main class="page-content" role="main">
        <div class="container-fluid">
            <!-- Navigation Breadcrumb -->
            <nav class="nav-breadcrumb">
                <a href="dashboard.html"><i class="bi bi-house me-1"></i>Dashboard</a>
                <span class="text-muted mx-2">/</span>
                <span class="text-muted">Text-to-Speech</span>
            </nav>

        <header class="page-header">
            <h1 class="page-title">
                <i class="bi bi-volume-up"></i>
                Text-to-Speech
            </h1>
            <p class="page-subtitle">Convert text to natural-sounding speech</p>
        </header>

        <div class="row g-4">
            <!-- Main Text Editor -->
            <div class="col-lg-8">
                <div class="card editor-panel h-100">
                    <div class="card-body">
                        <div class="editor">
                            <label for="text" class="form-label fw-semibold">
                                <i class="bi bi-textarea-t me-2"></i>Text to read
                            </label>
                            <textarea id="text" class="form-control main-editor" rows="15" placeholder="Type or paste text here, or use the file button to load a .txt file."></textarea>
                            
                            <!-- Reading Controls -->
                            <div class="reading-controls mt-3 mb-3">
                                <div class="d-flex gap-2 justify-content-between align-items-center">
                                    <div class="d-flex gap-2">
                                        <button id="readFromCursor" class="btn btn-info btn-sm" title="Start reading from cursor position">
                                            <i class="bi bi-cursor-text me-1"></i>From Cursor
                                        </button>
                                        <button id="readSelection" class="btn btn-secondary btn-sm" title="Read selected text">
                                            <i class="bi bi-selection me-1"></i>Read Selection
                                        </button>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <label class="btn btn-primary btn-sm" for="file">
                                            <i class="bi bi-upload me-1"></i>Upload File
                                        </label>
                                        <input id="file" type="file" accept=".txt" class="d-none" />
                                        <div class="form-check">
                                            <input id="fileAutoSpeak" type="checkbox" class="form-check-input" />
                                            <label class="form-check-label small" for="fileAutoSpeak">Auto speak</label>
                                        </div>
                                        <button id="loadSample" class="btn btn-outline-light btn-sm">
                                            <i class="bi bi-file-text me-1"></i>Sample
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="tokenized" class="tokenized mt-3" hidden aria-hidden="true"></div>

                            <!-- Playback Controls -->
                            <div class="playback-controls mt-4">
                                <div class="d-flex justify-content-center align-items-center">
                                    <button id="prev" class="btn btn-outline-light btn-sm me-3" title="Previous">
                                        <i class="bi bi-skip-backward-fill"></i>
                                    </button>
                                    <button id="play" class="control-btn play" title="Play / Resume">
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                    <button id="pause" class="control-btn pause" title="Pause">
                                        <i class="bi bi-pause-fill"></i>
                                    </button>
                                    <button id="stop" class="control-btn stop" title="Stop">
                                        <i class="bi bi-stop-fill"></i>
                                    </button>
                                    <button id="next" class="btn btn-outline-light btn-sm ms-3" title="Next">
                                        <i class="bi bi-skip-forward-fill"></i>
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <span id="statusText" class="badge bg-success">idle</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Voice Settings Panel -->
            <div class="col-lg-4">
                <div class="tools-panel">
                    <!-- Voice Selection -->
                    <div class="card control-group mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-person-voice me-2"></i>Voice Selection</h6>
                        </div>
                        <div class="card-body">
                            <div class="voice-preview-section">
                                <div class="row g-2 align-items-center mb-2">
                                    <div class="col">
                                        <select id="voice" class="form-select form-select-sm"></select>
                                    </div>
                                    <div class="col-auto">
                                        <button id="voicePreview" class="btn btn-outline-primary btn-sm" title="Preview voice">
                                            <i class="bi bi-volume-up"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="row g-2 align-items-center mb-2">
                                    <div class="col-auto">
                                        <label for="gender" class="form-label small mb-0">Gender:</label>
                                    </div>
                                    <div class="col">
                                        <select id="gender" class="form-select form-select-sm">
                                            <option value="any">Any</option>
                                            <option value="female">Female</option>
                                            <option value="male">Male</option>
                                        </select>
                                    </div>
                                    <div class="col-auto">
                                        <button id="suggestVoice" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-magic"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="form-check mb-2">
                                    <input id="requireGender" type="checkbox" class="form-check-input" />
                                    <label class="form-check-label small" for="requireGender">Require preferred gender</label>
                                </div>
                                <div id="voiceWarning" class="text-muted small mb-2"></div>
                                <button id="showVoices" class="btn btn-outline-light btn-sm w-100" title="List all voices">
                                    <i class="bi bi-list me-1"></i>Show All Voices
                                </button>
                                <div id="voiceList" class="text-muted small mt-2" hidden></div>
                            </div>
                        </div>
                    </div>

                    <!-- Playback Settings -->
                    <div class="card control-group mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-sliders me-2"></i>Playback Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="rate" class="form-label small d-flex justify-content-between">
                                    <span>Speed</span>
                                    <span id="rateVal" class="badge bg-secondary">1.0</span>
                                </label>
                                <input id="rate" type="range" class="form-range" min="0.5" max="2.0" step="0.1" value="1" />
                            </div>
                            <div class="mb-3">
                                <label for="pitch" class="form-label small d-flex justify-content-between">
                                    <span>Pitch</span>
                                    <span id="pitchVal" class="badge bg-secondary">1.0</span>
                                </label>
                                <input id="pitch" type="range" class="form-range" min="0" max="2" step="0.1" value="1" />
                            </div>
                            <div class="mb-3">
                                <label for="volume" class="form-label small d-flex justify-content-between">
                                    <span>Volume</span>
                                    <span id="volumeVal" class="badge bg-secondary">1.0</span>
                                </label>
                                <input id="volume" type="range" class="form-range" min="0" max="1" step="0.05" value="1" />
                            </div>
                            <div class="mb-3">
                                <label for="segmentDelay" class="form-label small d-flex justify-content-between">
                                    <span>Sentence pause</span>
                                    <span><span id="segmentDelayVal" class="badge bg-secondary">200</span> ms</span>
                                </label>
                                <input id="segmentDelay" type="range" class="form-range" min="0" max="800" step="25" value="200" />
                            </div>
                            <div class="form-check">
                                <input id="highlight" type="checkbox" class="form-check-input" checked />
                                <label class="form-check-label small" for="highlight">Highlight words while reading</label>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card control-group mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="navigateTo('ocr.html')">
                                    <i class="bi bi-camera me-2"></i>OCR Tools
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="navigateTo('translation.html')">
                                    <i class="bi bi-translate me-2"></i>Translation
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="navigateTo('voice-input.html')">
                                    <i class="bi bi-mic me-2"></i>Voice Input
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="navigateTo('settings.html')">
                                    <i class="bi bi-gear me-2"></i>Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Keyboard Shortcuts -->
                    <div class="card control-group">
                        <div class="card-body">
                            <div class="text-muted small">
                                <strong>Keyboard Shortcuts:</strong><br>
                                <kbd>Space</kbd> Play/Pause<br>
                                <kbd>S</kbd> Stop<br>
                                <kbd>L</kbd> Load sample
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced colorful accent elements -->
        <div class="cosmic-accents">
            <div class="accent-line accent-line-1"></div>
            <div class="accent-line accent-line-2"></div>
            <div class="accent-dot accent-dot-1"></div>
            <div class="accent-dot accent-dot-2"></div>
            <div class="cosmic-shape shape-triangle"></div>
            <div class="cosmic-shape shape-diamond"></div>
            <div class="sparkle sparkle-1"></div>
            <div class="sparkle sparkle-2"></div>
        </div>

        <footer class="cosmic-footer">
            <div class="footer-content">
                <div class="footer-glow"></div>
                <small>
                    <i class="bi bi-stars me-2"></i>
                    Text-to-Speech Tool ‚Äî Moon Stoners TTS Reader
                    <i class="bi bi-stars ms-2"></i>
                </small>
            </div>
        </footer>
        </div>
    </main>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Authentication Database -->
    <script src="auth-db.js"></script>
    <!-- Shared Navigation -->
    <script src="shared-navigation.js"></script>
    <!-- Voice Quality Enhancement System -->
    <script src="voice-quality-enhancer.js"></script>
    
    <script>
        // Navigation function
        function navigateTo(page) {
            window.location.href = page;
        }

        // Include the TTS functionality from kc.js (simplified version)
        // This would include all the TTS-related functions from the original kc.js
        // For brevity, I'm including the essential parts here
        
        // Authentication check
        const isLoggedIn = localStorage.getItem('kc_logged_in');
        const currentUser = localStorage.getItem('kc_user');
        
        if(!(isLoggedIn === '1')){
            window.location.href = 'login.html';
        }



        // Enhanced TTS Implementation with Quality Improvements
        let currentUtterance = null;
        let isPlaying = false;
        let isPaused = false;
        let voices = [];
        let currentWordIndex = 0;
        let words = [];
        let enhancedTTS = null;

        // Enhanced voice loading with quality analysis
        async function loadVoices() {
            if (!enhancedTTS) {
                enhancedTTS = new EnhancedTTSManager();
                await enhancedTTS.initialize();
            }

            const qualityInfo = enhancedTTS.getVoiceQualityInfo();
            voices = qualityInfo.availableVoices;
            
            const voiceSelect = document.getElementById('voice');
            voiceSelect.innerHTML = '';
            
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.voiceURI;
                
                // Add quality indicator to voice name
                const qualityIcon = voice.qualityScore >= 80 ? '‚≠ê' : 
                                  voice.qualityScore >= 60 ? '‚úì' : '';
                const genderIcon = voice.characteristics.gender === 'female' ? '‚ôÄ' : 
                                 voice.characteristics.gender === 'male' ? '‚ôÇ' : '';
                
                option.textContent = `${qualityIcon} ${voice.name} ${genderIcon} (${voice.lang || 'unknown'}) - Quality: ${voice.qualityScore}%`;
                
                // Mark recommended voices
                if (voice.isRecommended) {
                    option.style.fontWeight = 'bold';
                    option.style.color = '#28a745';
                }
                
                voiceSelect.appendChild(option);
            });
            
            // Auto-select best voice or load saved voice
            const savedVoice = localStorage.getItem('kc_tts_voice');
            if (savedVoice) {
                voiceSelect.value = savedVoice;
            } else if (voices.length > 0) {
                // Select the highest quality voice by default
                voiceSelect.value = voices[0].voiceURI;
                localStorage.setItem('kc_tts_voice', voices[0].voiceURI);
            }

            // Update voice warnings and recommendations
            updateVoiceRecommendations();
        }

        // Load settings
        function loadSettings() {
            document.getElementById('rate').value = localStorage.getItem('kc_tts_rate') || '1';
            document.getElementById('pitch').value = localStorage.getItem('kc_tts_pitch') || '1';
            document.getElementById('volume').value = localStorage.getItem('kc_tts_volume') || '1';
            document.getElementById('segmentDelay').value = localStorage.getItem('kc_tts_segmentDelay') || '200';
            document.getElementById('highlight').checked = localStorage.getItem('kc_tts_highlight') !== '0';
            
            updateSliderValues();
        }

        // Update slider display values
        function updateSliderValues() {
            document.getElementById('rateVal').textContent = document.getElementById('rate').value;
            document.getElementById('pitchVal').textContent = document.getElementById('pitch').value;
            document.getElementById('volumeVal').textContent = document.getElementById('volume').value;
            document.getElementById('segmentDelayVal').textContent = document.getElementById('segmentDelay').value;
        }

        // Save settings
        function saveSettings() {
            localStorage.setItem('kc_tts_voice', document.getElementById('voice').value);
            localStorage.setItem('kc_tts_rate', document.getElementById('rate').value);
            localStorage.setItem('kc_tts_pitch', document.getElementById('pitch').value);
            localStorage.setItem('kc_tts_volume', document.getElementById('volume').value);
            localStorage.setItem('kc_tts_segmentDelay', document.getElementById('segmentDelay').value);
            localStorage.setItem('kc_tts_highlight', document.getElementById('highlight').checked ? '1' : '0');
        }

        // Status function
        function setStatus(message, className = 'bg-secondary') {
            const statusText = document.getElementById('statusText');
            statusText.textContent = message;
            statusText.className = `badge ${className}`;
        }

        // Create enhanced utterance with quality optimization
        function createUtterance(text) {
            if (!enhancedTTS) {
                // Fallback to basic utterance if enhancement system not loaded
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = parseFloat(document.getElementById('rate').value);
                utterance.pitch = parseFloat(document.getElementById('pitch').value);
                utterance.volume = parseFloat(document.getElementById('volume').value);
                return utterance;
            }

            // Get current parameters
            const params = {
                rate: parseFloat(document.getElementById('rate').value),
                pitch: parseFloat(document.getElementById('pitch').value),
                volume: parseFloat(document.getElementById('volume').value)
            };

            // Update voice selection if changed
            const selectedVoiceURI = document.getElementById('voice').value;
            const selectedVoiceAnalysis = voices.find(v => v.voiceURI === selectedVoiceURI);
            
            if (selectedVoiceAnalysis) {
                const actualVoice = speechSynthesis.getVoices().find(v => 
                    (v.voiceURI || v.name) === selectedVoiceURI
                );
                if (actualVoice) {
                    enhancedTTS.currentVoice = actualVoice;
                    enhancedTTS.currentVoiceAnalysis = selectedVoiceAnalysis;
                }
            }

            // Create optimized utterance
            const utterance = enhancedTTS.createOptimizedUtterance(text, params);
            
            return utterance;
        }

        // Tokenize text for highlighting
        function tokenizeText(text) {
            words = text.split(/(\s+)/).filter(word => word.trim().length > 0);
            const tokenizedDiv = document.getElementById('tokenized');
            
            if (document.getElementById('highlight').checked) {
                tokenizedDiv.innerHTML = words.map((word, index) => 
                    `<span class="word" data-index="${index}">${word}</span>`
                ).join(' ');
                tokenizedDiv.hidden = false;
            } else {
                tokenizedDiv.hidden = true;
            }
        }

        // Highlight current word
        function highlightWord(index) {
            if (!document.getElementById('highlight').checked) return;
            
            document.querySelectorAll('.word').forEach((span, i) => {
                if (i === index) {
                    span.classList.add('active');
                } else {
                    span.classList.remove('active');
                }
            });
        }

        // Play text
        function playText() {
            const text = document.getElementById('text').value.trim();
            if (!text) {
                setStatus('No text to read', 'bg-warning');
                return;
            }

            if (isPaused && currentUtterance) {
                speechSynthesis.resume();
                isPaused = false;
                isPlaying = true;
                setStatus('Resumed', 'bg-success');
                return;
            }

            stopText();
            tokenizeText(text);
            
            currentUtterance = createUtterance(text);
            currentWordIndex = 0;
            
            currentUtterance.onstart = () => {
                isPlaying = true;
                isPaused = false;
                setStatus('Speaking', 'bg-success');
            };
            
            currentUtterance.onend = () => {
                isPlaying = false;
                isPaused = false;
                setStatus('Finished', 'bg-secondary');
                highlightWord(-1); // Clear highlighting
            };
            
            currentUtterance.onerror = (event) => {
                isPlaying = false;
                isPaused = false;
                setStatus('Error: ' + event.error, 'bg-danger');
            };
            
            // Simple word highlighting (approximate)
            if (document.getElementById('highlight').checked) {
                const wordCount = words.length;
                const duration = text.length / (parseFloat(document.getElementById('rate').value) * 10); // Rough estimate
                const wordInterval = (duration * 1000) / wordCount;
                
                let wordTimer = setInterval(() => {
                    if (!isPlaying || currentWordIndex >= wordCount) {
                        clearInterval(wordTimer);
                        return;
                    }
                    highlightWord(currentWordIndex);
                    currentWordIndex++;
                }, wordInterval);
            }
            
            speechSynthesis.speak(currentUtterance);
            saveSettings();
        }

        // Pause text
        function pauseText() {
            if (isPlaying && !isPaused) {
                speechSynthesis.pause();
                isPaused = true;
                isPlaying = false;
                setStatus('Paused', 'bg-warning');
            }
        }

        // Stop text
        function stopText() {
            speechSynthesis.cancel();
            isPlaying = false;
            isPaused = false;
            currentUtterance = null;
            currentWordIndex = 0;
            setStatus('Stopped', 'bg-secondary');
            highlightWord(-1); // Clear highlighting
        }

        // Load sample text
        function loadSample() {
            const sample = `Hello ‚Äî welcome to the Text-to-Speech tool.\n\nThis is a dedicated interface for converting text to natural-sounding speech. You can adjust voice settings, playback speed, and use advanced features like word highlighting.\n\nUse the controls on the right to customize your experience, then press Play to hear your text.`;
            document.getElementById('text').value = sample;
            setStatus('Sample loaded', 'bg-info');
        }

        // Enhanced voice preview with quality test
        function previewVoice() {
            if (enhancedTTS) {
                const selectedVoiceURI = document.getElementById('voice').value;
                const actualVoice = speechSynthesis.getVoices().find(v => 
                    (v.voiceURI || v.name) === selectedVoiceURI
                );
                
                if (actualVoice) {
                    const params = {
                        rate: parseFloat(document.getElementById('rate').value),
                        pitch: parseFloat(document.getElementById('pitch').value),
                        volume: parseFloat(document.getElementById('volume').value)
                    };
                    
                    const testUtterance = enhancedTTS.testVoice(actualVoice, params);
                    speechSynthesis.speak(testUtterance);
                    return;
                }
            }
            
            // Fallback to basic preview
            const utterance = createUtterance('This is a preview of the selected voice with enhanced quality optimization.');
            speechSynthesis.speak(utterance);
        }

        // File upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('text').value = e.target.result;
                    setStatus('File loaded', 'bg-info');
                    
                    if (document.getElementById('fileAutoSpeak').checked) {
                        setTimeout(playText, 500);
                    }
                };
                reader.readAsText(file);
            } else {
                setStatus('Please select a .txt file', 'bg-warning');
            }
        }

        // Event Listeners
        document.getElementById('play').addEventListener('click', playText);
        document.getElementById('pause').addEventListener('click', pauseText);
        document.getElementById('stop').addEventListener('click', stopText);
        document.getElementById('loadSample').addEventListener('click', loadSample);
        document.getElementById('voicePreview').addEventListener('click', previewVoice);
        document.getElementById('file').addEventListener('change', handleFileUpload);

        // Settings event listeners
        document.getElementById('rate').addEventListener('input', updateSliderValues);
        document.getElementById('pitch').addEventListener('input', updateSliderValues);
        document.getElementById('volume').addEventListener('input', updateSliderValues);
        document.getElementById('segmentDelay').addEventListener('input', updateSliderValues);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            
            switch(e.key.toLowerCase()) {
                case ' ':
                    e.preventDefault();
                    if (isPlaying) pauseText();
                    else playText();
                    break;
                case 's':
                    e.preventDefault();
                    stopText();
                    break;
                case 'l':
                    e.preventDefault();
                    loadSample();
                    break;
            }
        });

        // Voice recommendation system
        function updateVoiceRecommendations() {
            if (!enhancedTTS) return;

            const qualityInfo = enhancedTTS.getVoiceQualityInfo();
            const warningDiv = document.getElementById('voiceWarning');
            
            if (qualityInfo.recommendations && qualityInfo.recommendations.length > 0) {
                const recommendations = qualityInfo.recommendations.map(rec => 
                    `<small class="text-warning">üí° ${rec.message}</small>`
                ).join('<br>');
                warningDiv.innerHTML = recommendations;
            } else if (qualityInfo.currentVoice) {
                const quality = qualityInfo.currentVoice.qualityScore;
                if (quality >= 80) {
                    warningDiv.innerHTML = '<small class="text-success">‚úÖ Excellent voice quality selected</small>';
                } else if (quality >= 60) {
                    warningDiv.innerHTML = '<small class="text-info">‚ÑπÔ∏è Good voice quality</small>';
                } else {
                    warningDiv.innerHTML = '<small class="text-warning">‚ö†Ô∏è Consider selecting a higher quality voice</small>';
                }
            }
        }

        // Voice suggestion based on gender preference
        function suggestVoice() {
            if (!enhancedTTS) return;

            const genderPref = document.getElementById('gender').value;
            const requireGender = document.getElementById('requireGender').checked;
            
            const preferences = {
                gender: genderPref === 'any' ? null : genderPref,
                requireGender: requireGender
            };

            const bestVoice = enhancedTTS.voiceAnalyzer.getBestVoice(
                voices.map(v => speechSynthesis.getVoices().find(sv => 
                    (sv.voiceURI || sv.name) === v.voiceURI
                )).filter(Boolean), 
                preferences
            );

            if (bestVoice) {
                document.getElementById('voice').value = bestVoice.voiceURI;
                updateVoiceRecommendations();
                
                // Show notification
                setStatus(`Suggested: ${bestVoice.name} (Quality: ${bestVoice.qualityScore}%)`, 'bg-info');
            }
        }

        // Show all voices with quality info
        function showAllVoices() {
            const voiceList = document.getElementById('voiceList');
            
            if (voiceList.hidden) {
                let voiceInfo = voices.map(voice => {
                    const qualityBar = '‚ñà'.repeat(Math.floor(voice.qualityScore / 10));
                    const genderIcon = voice.characteristics.gender === 'female' ? '‚ôÄ' : 
                                     voice.characteristics.gender === 'male' ? '‚ôÇ' : '‚ö™';
                    
                    return `<div class="mb-1">
                        <strong>${voice.name}</strong> ${genderIcon}<br>
                        <small>Quality: ${voice.qualityScore}% ${qualityBar}</small><br>
                        <small>Clarity: ${voice.clarity}% | Natural: ${voice.naturalness}% | Pronunciation: ${voice.pronunciation}%</small>
                    </div>`;
                }).join('');
                
                voiceList.innerHTML = voiceInfo;
                voiceList.hidden = false;
                document.getElementById('showVoices').innerHTML = '<i class="bi bi-eye-slash me-1"></i>Hide Voices';
            } else {
                voiceList.hidden = true;
                document.getElementById('showVoices').innerHTML = '<i class="bi bi-list me-1"></i>Show All Voices';
            }
        }

        // Add event listeners for new features
        document.getElementById('suggestVoice').addEventListener('click', suggestVoice);
        document.getElementById('showVoices').addEventListener('click', showAllVoices);
        
        // Update recommendations when voice changes
        document.getElementById('voice').addEventListener('change', updateVoiceRecommendations);

        // Initialize enhanced TTS system
        setTimeout(async () => {
            try {
                await loadVoices();
                loadSettings();
                setStatus('Enhanced TTS Ready - Voice Quality Optimized', 'bg-success');
            } catch (error) {
                console.error('Failed to initialize enhanced TTS:', error);
                setStatus('TTS Ready (Basic Mode)', 'bg-warning');
            }
        }, 100);

        // Load voices when they become available
        speechSynthesis.onvoiceschanged = loadVoices;

        console.log('Enhanced TTS page loaded successfully');
    </script>
</body>
</html>